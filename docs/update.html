<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#222222">
  <title>Bowie Phone - Firmware Update</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
  <style>
    :root {
      --bg: #1a1a2e;
      --bg-card: #16213e;
      --accent: #e94560;
      --accent-hover: #ff6b6b;
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --success: #4ade80;
      --border: #0f3460;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #0f0f23 100%);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    .container {
      max-width: 600px;
      width: 100%;
    }
    h1 {
      text-align: center;
      margin: 0 0 0.5rem;
      font-size: 2rem;
    }
    h1 span { font-size: 2.5rem; }
    .subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 2rem;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card h2 {
      margin: 0 0 1rem;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .version-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .version-label { color: var(--text-muted); }
    .version-value { 
      font-family: monospace;
      font-size: 1.1rem;
      color: var(--success);
    }
    .install-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    esp-web-install-button {
      --esp-tools-button-color: var(--accent);
      --esp-tools-button-text-color: white;
    }
    .install-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 1rem 2.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .install-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
    }
    .help-text {
      color: var(--text-muted);
      font-size: 0.9rem;
      text-align: center;
    }
    .help-text a {
      color: var(--accent);
    }
    ol, ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }
    li { margin: 0.5rem 0; }
    code {
      background: rgba(0,0,0,0.3);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .method-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.75rem;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    .tab-btn:hover { background: rgba(0,0,0,0.3); }
    .tab-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #unsupported {
      display: none;
      text-align: center;
      padding: 1rem;
      background: rgba(233, 69, 96, 0.2);
      border-radius: 8px;
    }
    .note {
      background: rgba(74, 222, 128, 0.1);
      border-left: 3px solid var(--success);
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    footer {
      margin-top: auto;
      padding-top: 2rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    footer a { color: var(--accent); }
    @media (prefers-color-scheme: dark) {
      ewt-install-dialog {
        --mdc-theme-surface: #16213e;
        --mdc-dialog-heading-ink-color: #eaeaea;
        --mdc-dialog-content-ink-color: #a0a0a0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span>üìû</span> Bowie Phone</h1>
    <p class="subtitle">Firmware Update Tool</p>

    <div class="card">
      <h2>üì¶ Current Release</h2>
      <div class="version-info">
        <span class="version-label">Version</span>
        <span class="version-value" id="version">1.0.0</span>
      </div>
      
      <div class="method-tabs">
        <button class="tab-btn active" onclick="showTab('usb')">üîå USB / Serial</button>
        <button class="tab-btn" onclick="showTab('ota')">üì° OTA (Wi-Fi)</button>
      </div>

      <div id="usb-tab" class="tab-content active">
        <div id="unsupported">
          <p>‚ö†Ô∏è Web Serial is not supported in this browser.</p>
          <p>Please use <strong>Chrome</strong> or <strong>Edge</strong> on desktop.</p>
        </div>
        
        <div id="flasher" class="install-section">
          <esp-web-install-button id="install-btn" manifest="firmware/manifest.json">
            <button class="install-btn" slot="activate">‚ö° Install Firmware</button>
          </esp-web-install-button>
          <p class="help-text">
            Connect your ESP32 via USB and click Install.<br>
            <a href="#" onclick="showHelp(); return false;">Device not showing up?</a>
          </p>
        </div>
        
        <div id="serial-help" style="display: none;">
          <p><strong>Troubleshooting:</strong></p>
          <ul>
            <li>Ensure your USB cable supports data (not power-only)</li>
            <li>Try a different USB port</li>
            <li>Install drivers for your USB-serial chip:
              <ul>
                <li><a href="https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers" target="_blank">CP210x (square chip)</a></li>
                <li><a href="https://www.wch.cn/downloads/CH341SER_ZIP.html" target="_blank">CH340/CH341</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="ota-tab" class="tab-content">
        <p>If your Bowie Phone is already running firmware with OTA enabled:</p>
        <ol>
          <li>Ensure the device is connected to Wi-Fi</li>
          <li>Find the device IP or use <code>bowie-phone.local</code></li>
          <li>Use PlatformIO or the Arduino IDE to upload via OTA:
            <pre style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; overflow-x: auto;"><code>pio run -t upload --upload-port bowie-phone.local</code></pre>
          </li>
        </ol>
        <div class="note">
          üí° <strong>Tip:</strong> OTA password is configured in <code>platformio.ini</code> via <code>OTA_PASSWORD</code>.
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üìã Instructions</h2>
      <ol>
        <li>Connect your ESP32 board to your computer via USB</li>
        <li>Click <strong>"Install Firmware"</strong> above</li>
        <li>Select your device's COM/serial port</li>
        <li>Wait for the installation to complete (~30 seconds)</li>
        <li>The device will reboot and start the Wi-Fi setup portal</li>
      </ol>
    </div>
  </div>

  <footer>
    Powered by <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a><br>
    <a href="index.html">‚Üê Back to Sequence Manager</a>
  </footer>

  <script>
    // Check browser support
    if (!('serial' in navigator)) {
      document.getElementById('flasher').style.display = 'none';
      document.getElementById('unsupported').style.display = 'block';
    }

    // Tab switching
    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
    }

    // Show driver help
    function showHelp() {
      document.getElementById('serial-help').style.display = 'block';
    }

    // Load version from manifest
    fetch('firmware/manifest.json')
      .then(r => r.json())
      .then(m => {
        document.getElementById('version').textContent = m.version || '1.0.0';
      })
      .catch(() => {});
  </script>
</body>
</html>
