[platformio]
default_envs = bowie-phone-1

; ============================================
; Base Configuration - Common to all devices
; ============================================
[env:base]
platform = espressif32
board = esp32dev
framework = arduino
board_build.partitions = min_spiffs.csv
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
build_flags =
#  -DAUDIOKIT_BOARD=5
#  -DCORE_DEBUG_LEVEL=0
  -DDEBUG
  -Os
#  -ffunction-sections
#  -fdata-sections
#  -Wl,--gc-sections
#  -DARDUINO_LOOP_STACK_SIZE=8192
  -DBOARD_HAS_PSRAM
#  -mfix-esp32-psram-cache-issue
  ; Increase HTTP line buffer for long Google Drive URLs with access tokens
  -DHTTP_MAX_LEN=2048
#  -DDISABLE_ALL_LIBRARY_WARNINGS
#  -DARDUINO_SERIAL_EVENT_TASK_STACK_SIZE=4096
#  -DARDUINO_SERIAL_EVENT_TASK_PRIORITY=1
#  -Wno-unused-variable
#  -Wno-unused-but-set-variable
#  -Wno-unused-function
#  -Wno-format-extra-args
#  -w
  ; WiFi Configuration - Change these values as needed
  -DWIFI_AP_NAME=\"Phone-Setup\"
  -DWIFI_AP_PASSWORD=\"jump-phone-2000\"
  ; Firmware Version - Increment this to force cache reset on next upload
  -DFIRMWARE_VERSION=\"1.0.2\"
  ; OTA Configuration - Change these values as needed

  -DOTA_PASSWORD=\"photo-ota-2000\"
  -DOTA_PORT=3232
  ; Known Sequences Configuration - Uses universal Apps Script endpoint
  ; The endpoint returns sequence.json format for firmware
  -DKNOWN_SEQUENCES_URL=\"https://script.google.com/macros/s/AKfycbwA9YLBm1Q4hrLwzlq8GF2kiQippL5_SkFB0shJA8U6REI2F6CYj4mD0XCRXd86SMps/exec?action=getSequenceManifest&sheetId=1q1FOzSTg-5ATMSlVf_cuIaPvYgMv9yDec4Nd5ZaAlzY&gid=0&driveFolderId=1TGRbklQEoJpt1AbR3LOpW0t8unVnzkQ5\"
  ; -DSD_CS_PIN=5  ; SD card chip select pin (adjust for your board)
  ; Audio Input Device Configuration (uncomment one or use default ADC_INPUT_ALL)
  ; -DAUDIO_INPUT_DEVICE=ADC_INPUT_LINE1  ; Microphone only
  -DAUDIO_INPUT_DEVICE=ADC_INPUT_LINE2  ; Line in only  
  ; -DAUDIO_INPUT_DEVICE=ADC_INPUT_LINE3  ; Right mic + left line in
  ; -DAUDIO_INPUT_DEVICE=ADC_INPUT_ALL    ; Both microphone and line in (default)
  ; -DFORCE_URL_STREAMING=1
  ; Dialtone Configuration
  -DENABLE_DIALTONE=1
  ; WiFi Configuration - Clear on boot
  ; Uncomment to clear all saved WiFi credentials on next boot (then re-comment and reflash)
  ; -DCLEAR_WIFI_ON_BOOT
  ; Tailscale/WireGuard VPN Configuration  ; GPIO pin for Tailscale enable detection at boot (default: 36 = KEY1)
  ; -DTAILSCALE_ENABLE_PIN=36
  ; Uncomment to always enable Tailscale regardless of key state
  ; -DDEFAULT_SSID=\"Dream\ House\"
  ; -DDEFAULT_PASSWORD=\"butnotforbarbies\"
  ; -DDEFAULT_SSID=\"The\ Universal\ Wavefunction\"
  ; -DDEFAULT_PASSWORD=\"likesbutts\"
  ; WireGuard Common Configuration
  -DWIREGUARD_PEER_PUBLIC_KEY=\"JLGe7Vfn+JM8T0992An7yf6gBVQ00Af/Zz6jpCcQeWE=\"
  -DWIREGUARD_PEER_ENDPOINT=\"jumprouter.infinitebutts.com\"
  -DWIREGUARD_PEER_PORT=51820
  ; Remote Logging Configuration (over VPN)
  -DREMOTE_LOG_SERVER=\"http://10.253.0.1:3000/logs\"
  ; Unraid server for OTA deployment
  -DUNRAID_SERVER_IP=\"100.86.189.46\"
lib_deps =
  https://github.com/pschatzmann/arduino-audio-driver.git
  https://github.com/pschatzmann/arduino-audio-tools.git
  https://github.com/pschatzmann/arduino-audiokit.git
  https://github.com/pschatzmann/arduino-libhelix.git
  https://github.com/ciniml/WireGuard-ESP32-Arduino.git
  https://github.com/LennartHennigs/ESPTelnet.git
  ArduinoOTA
  bblanchon/ArduinoJson@^7.0.4
; Exclude legacy audio_player.cpp - using extended_audio_player instead
build_src_filter = +<*> -<audio_player.cpp>
upload_resetmethod = usb_reset
; Flash settings for OTA compatibility - DIO mode for ESP32-D0WD-V3
; QIO mode uses GPIO 2 which conflicts with SD card MISO on AudioKit
board_build.flash_mode = dio
board_build.f_flash = 40000000L
upload_port = COM3
monitor_port = COM3

; ============================================
; Device-Specific Configurations
; ============================================

[env:bowie-phone-1]
extends = env:base
build_flags =
  ${env:base.build_flags}
  -DWIFI_AP_NAME=\"Bowie-Phone-Setup\"
  -DWIFI_AP_PASSWORD=\"ziggystardust\"
  -DPHONE=BOWIE_PHONE
  -DTAILSCALE_ALWAYS_ENABLED  ; Generate keys: wg genkey | tee privatekey | wg pubkey > publickey
  -DUSE_GOERTZEL_ONLY
  -DOTA_HOSTNAME=\"bowie-phone\"
  -DDEFAULT_SSID=\"HMS\ Honeypot\"
  -DDEFAULT_PASSWORD=\"cutebutdangerous\"
  -DFALLBACK_SSID_1=\"House\ Atreides\"
  -DFALLBACK_PASSWORD_1=\"desertpower\"
  -DWIREGUARD_PRIVATE_KEY=\"oKQVt6GM4zlNEKvHZFoX6R5VCy4f32VRg1+4I9Rf6Ug=\"
  -DWIREGUARD_LOCAL_IP=\"10.253.0.2\"
  -DREMOTE_LOG_DEVICE_ID=\"bowie-phone-1\"


[env:dream-phone-1]
extends = env:base
upload_port = COM3
monitor_port = COM3
build_flags =
  ${env:base.build_flags}
  -DPHONE=DREAM_PHONE
  ; Dream phone works better with Goertzel-only DTMF detection
  -DMIN_KEYDOWN_SAMPLES=2
  -DMIN_AVG_ROW_MAG=5.0f
  -DUSE_GOERTZEL_ONLY
  -DDEFAULT_SSID=\"Dream\ House\"
  -DDEFAULT_PASSWORD=\"butnotforbarbies\"
  -DOTA_HOSTNAME=\"dream-phone\"
  -DWIREGUARD_LOCAL_IP=\"10.253.0.3\"
  -DREMOTE_LOG_DEVICE_ID=\"dream-phone-1\"

[env:brophone]
extends = env:base
build_flags =
  ${env:base.build_flags}
  -DOTA_HOSTNAME=\"brophone\"
  -DWIREGUARD_PRIVATE_KEY=\"GENERATE_NEW_KEY_HERE\"  ; TODO: Generate with: wg genkey
  -DWIREGUARD_LOCAL_IP=\"10.253.0.3\"
  -DREMOTE_LOG_DEVICE_ID=\"brophone\"

[env:brophone-ota]
extends = env:brophone
upload_protocol = espota
upload_port = 192.168.1.240  ; TODO: Update with brophone's local IP
upload_flags =
  --port=3232
  --auth=bowie-ota-2024

[env:brophone-ota-vpn]
extends = env:brophone
upload_protocol = espota
upload_port = 10.253.0.3
upload_flags =
  --port=3232
  --auth=bowie-ota-2024

